#!/usr/bin/env node

/**
 * Automated Email Setup Script for CryptoRafts
 * This script will guide you through the complete setup process
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { execSync } from 'child_process';
import readline from 'readline';

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query: string): Promise<string> {
  return new Promise(resolve => rl.question(query, resolve));
}

async function automatedSetup() {
  console.log('üöÄ CryptoRafts Email Setup Automation');
  console.log('=====================================\n');

  try {
    // Step 1: Check if .env.local exists
    console.log('üìã Step 1: Checking environment configuration...');
    
    if (!existsSync('.env.local')) {
      console.log('‚úÖ Creating .env.local file...');
      
      const emailUser = await question('Enter your business email (business@cryptorafts.com): ');
      const emailPassword = await question('Enter your Gmail app password: ');
      const appUrl = await question('Enter your app URL (https://cryptorafts.com): ');
      
      const envContent = `# CryptoRafts Email Configuration
# Generated by automated setup

# Gmail SMTP Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=${emailUser}
EMAIL_PASSWORD=${emailPassword}

# Application settings
NEXT_PUBLIC_APP_URL=${appUrl}
EMAIL_FROM_NAME=CryptoRafts
EMAIL_FROM_ADDRESS=${emailUser}

# Rate limiting
EMAIL_RATE_LIMIT_DELAY=1000
EMAIL_MAX_RETRIES=3
`;

      writeFileSync('.env.local', envContent);
      console.log('‚úÖ .env.local created successfully!');
    } else {
      console.log('‚úÖ .env.local already exists');
    }

    // Step 2: Install dependencies
    console.log('\nüì¶ Step 2: Installing email dependencies...');
    try {
      execSync('npm install nodemailer @types/nodemailer', { stdio: 'inherit' });
      console.log('‚úÖ Dependencies installed successfully!');
    } catch (error) {
      console.log('‚ö†Ô∏è Dependencies may already be installed');
    }

    // Step 3: Test email configuration
    console.log('\nüß™ Step 3: Testing email configuration...');
    
    const testEmail = await question('Enter a test email address to send a test email: ');
    
    if (testEmail) {
      try {
        // Create a simple test script
        const testScript = `
import { emailService } from './src/lib/email.service';

async function testEmail() {
  try {
    const result = await emailService.sendApprovalEmail({
      firstName: 'Test',
      lastName: 'User',
      email: '${testEmail}',
      company: 'Test Company',
      jobTitle: 'Test Role'
    });
    
    if (result) {
      console.log('‚úÖ Test email sent successfully!');
      console.log('üìß Check ${testEmail} for the test email');
    } else {
      console.log('‚ùå Failed to send test email');
    }
  } catch (error) {
    console.error('‚ùå Error:', error.message);
  }
}

testEmail();
`;

        writeFileSync('test-email-quick.js', testScript);
        
        console.log('üìß Sending test email...');
        execSync('node test-email-quick.js', { stdio: 'inherit' });
        
        // Clean up test file
        execSync('rm test-email-quick.js', { stdio: 'inherit' });
        
      } catch (error) {
        console.log('‚ö†Ô∏è Test email failed - check your credentials');
      }
    }

    // Step 4: Create admin shortcuts
    console.log('\n‚ö° Step 4: Creating admin shortcuts...');
    
    const adminScript = `
#!/usr/bin/env node

/**
 * Quick Admin Commands for CryptoRafts Email
 */

import { AdminEmailManager } from './src/lib/admin-email.manager';

async function runAdminCommand() {
  const command = process.argv[2];
  
  switch (command) {
    case 'stats':
      console.log('üìä Getting user statistics...');
      const users = await AdminEmailManager.getAllRegisteredUsers();
      const approved = await AdminEmailManager.getUsersByKYCStatus('approved');
      const pending = await AdminEmailManager.getUsersByKYCStatus('pending');
      
      console.log(\`Total Users: \${users.length}\`);
      console.log(\`Approved: \${approved.length}\`);
      console.log(\`Pending: \${pending.length}\`);
      break;
      
    case 'approve-all':
      console.log('üìß Sending approval emails to all users...');
      const result = await AdminEmailManager.sendApprovalEmailsToAllUsers();
      console.log(\`‚úÖ Sent: \${result.success}, Failed: \${result.failed}\`);
      break;
      
    case 'approve-pending':
      console.log('üìß Sending approval emails to pending users...');
      const pendingResult = await AdminEmailManager.sendApprovalEmailsByKYCStatus('pending');
      console.log(\`‚úÖ Sent: \${pendingResult.success}, Failed: \${pendingResult.failed}\`);
      break;
      
    default:
      console.log('Available commands:');
      console.log('  stats - Get user statistics');
      console.log('  approve-all - Send approval emails to all users');
      console.log('  approve-pending - Send approval emails to pending users');
  }
}

runAdminCommand().catch(console.error);
`;

    writeFileSync('admin-email.js', adminScript);
    console.log('‚úÖ Admin shortcuts created!');
    console.log('   Run: node admin-email.js stats');
    console.log('   Run: node admin-email.js approve-all');

    // Step 5: Final instructions
    console.log('\nüéâ Setup Complete!');
    console.log('==================');
    console.log('\nüìã What you need to do:');
    console.log('1. Set up business@cryptorafts.com in Gmail:');
    console.log('   - Gmail Settings ‚Üí Accounts and Import ‚Üí Add another email address');
    console.log('   - Enter: business@cryptorafts.com');
    console.log('   - Verify ownership');
    console.log('\n2. Enable 2-Factor Authentication on Gmail');
    console.log('\n3. Generate App Password:');
    console.log('   - Google Account ‚Üí Security ‚Üí App passwords');
    console.log('   - Create password for "Mail"');
    console.log('   - Update EMAIL_PASSWORD in .env.local');
    console.log('\n4. Test your setup:');
    console.log('   - Run: npx tsx scripts/test-email.ts');
    console.log('   - Visit: http://localhost:3001/admin/email');
    console.log('\n5. Send approval emails:');
    console.log('   - Run: node admin-email.js approve-all');
    console.log('   - Or use the web interface at /admin/email');

    console.log('\nüöÄ Your email system is ready!');
    console.log('All code is automated and ready to use.');

  } catch (error) {
    console.error('‚ùå Setup failed:', error);
  } finally {
    rl.close();
  }
}

// Run the automated setup
automatedSetup();
